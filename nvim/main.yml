---
- include_vars: ./variables.yml

- name: Make sure autoload directory exists
  file:
    path: "{{ config_path }}/autoload"
    state: directory
  tags: [nvim, setup]

- include: ./packer.yml
  tags: [nvim, packer]

- name: Make sure undo dir is present
  file:
    path: "{{ config_path }}/undodir"
    state: directory
  tags: [nvim, setup]

- name: Create directory after
  file:
    path: "{{ config_path }}/after"
    state: directory
  tags: [nvim, setup]

- name: Create directory ftplugin
  file:
    path: "{{ config_path }}/ftplugin"
    state: directory
  tags: [nvim, setup]

- name: Create directory lua
  file:
    path: "{{ config_path }}/lua"
    state: directory
  tags: [nvim, setup]

- name: Create directory lua/claude_nvim
  file:
    path: "{{ config_path }}/lua/claude_nvim"
    state: directory
  tags: [nvim, setup]

- name: Backup existing nvim config
  shell: |
    if [ -f "{{ config_path }}/init.lua" ]; then
      mkdir -p ~/.dotfiles-backup
      cp -r "{{ config_path }}" ~/.dotfiles-backup/nvim.$(date +%Y%m%d_%H%M%S)
    fi
  tags: [nvim, backup]

- name: Deploy config file {{ item.Path }}
  template:
    src: "{{ item.Src }}"
    dest: "{{ config_path }}/{{ item.Path }}"
  with_filetree: "./templates"
  when: item.State == "file"
  tags: [nvim, config]

- include: ./win32yank.yml
  when: use_win32yank
  tags: [nvim, win32yank]

- name: Make sure plugins are installed
  shell: nvim --headless -c 'autocmd User PackerComplete quitall' -c 'PackerSync'
  timeout: 15m
  retries: 2
  retry_delay: 10s
  tags: [nvim, plugins]

- include: ./copilot.yml
  tags: [nvim, copilot]

- name: Verify nvim installation
  assert:
    command:
      cmd: which nvim
  tags: [nvim, verify]

- name: Verify nvim config
  assert:
    command:
      cmd: test -f ~/.config/nvim/init.lua
  tags: [nvim, verify]

- name: Verify packer installation
  assert:
    command:
      cmd: test -d ~/.local/share/nvim/site/pack/packer/start/packer.nvim
  tags: [nvim, verify]
