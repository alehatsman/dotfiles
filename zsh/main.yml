---
- name: Install zsh (ubuntu)
  shell: apt-get install -y zsh
  become: true
  when: os == "linux"
  timeout: 5m
  retries: 3
  retry_delay: 5s
  tags: [zsh, install]

- name: Install zsh (macos)
  shell: brew install zsh 2>&1 | grep -v "already installed" || true
  when: os == "darwin"
  timeout: 5m
  retries: 3
  retry_delay: 5s
  tags: [zsh, install]

- name: Make sure zsh config directory is present
  file:
    path: ~/.config/zsh
    state: directory
  tags: [zsh, config]

- include_vars: ./vars/ubuntu_vars.yml
  when: os == 'linux'

- include_vars: ./vars/macos_{{arch}}.yml
  when: os == "darwin"

- name: Backup existing .zshrc
  shell: |
    if [ -f ~/.zshrc ]; then
      mkdir -p ~/.dotfiles-backup
      cp ~/.zshrc ~/.dotfiles-backup/.zshrc.$(date +%Y%m%d_%H%M%S)
    fi
  tags: [zsh, backup]

- name: Backup existing .ignore
  shell: |
    if [ -f ~/.ignore ]; then
      mkdir -p ~/.dotfiles-backup
      cp ~/.ignore ~/.dotfiles-backup/.ignore.$(date +%Y%m%d_%H%M%S)
    fi
  tags: [zsh, backup]

- name: Deploy .zshrc
  template:
    src: ./templates/.zshrc.j2
    dest: ~/.zshrc
  tags: [zsh, config]

- name: Deploy .ignore
  template:
    src: ./templates/.ignore.j2
    dest: ~/.ignore
  tags: [zsh, config]

- name: Clone zplug
  shell: |
    if [ ! -d ~/.zplug ]; then
      git clone --depth 1 https://github.com/zplug/zplug.git ~/.zplug
    fi
  timeout: 5m
  retries: 3
  retry_delay: 5s
  tags: [zsh, plugins]

- name: Clone oh-my-zsh
  shell: |
    if [ ! -d ~/.zplug/repos/ohmyzsh/ohmyzsh ]; then
      git clone --depth 1 https://github.com/ohmyzsh/ohmyzsh.git ~/.zplug/repos/ohmyzsh/ohmyzsh
    fi
  timeout: 5m
  retries: 3
  retry_delay: 5s
  tags: [zsh, plugins]

- name: Set zsh as default shell
  shell: |
    if ! echo "$SHELL" | grep -q zsh; then
      chsh -s $(which zsh) {{ username }}
    fi
  become: true
  tags: [zsh, shell]

- name: Verify zsh installation
  assert:
    command:
      cmd: which zsh
  tags: [zsh, verify]

- name: Verify zsh config
  assert:
    command:
      cmd: test -f ~/.zshrc
  tags: [zsh, verify]

- name: Verify zplug installation
  assert:
    command:
      cmd: test -d ~/.zplug
  tags: [zsh, verify]
